<?PHP
require('../wp-blog-header.php');

$con = mysql_connect("localhost","goupsmar","6pIlSh946q");
$DATABASE = "goupsmar_upsmart";

if (!$con)
  {
  die('Could not connect: ' . mysql_error());
  }

  function clean($elem)
  {
    if(!is_array($elem))
        $elem = htmlentities($elem,ENT_QUOTES,"UTF-8");
    else
        foreach ($elem as $key => $value)
            $elem[$key] = clean($value);
    return $elem;
 }

  $_CLEAN = clean($_GET); 
  $company = (!(array_key_exists('name', $_CLEAN)) || empty($_CLEAN)) ? "" : $_CLEAN['name'];
  
  $result = mysql_select_db($DATABASE, $con);
  if (!$result)
  {
  die('Could not select datbase: ' . mysql_error());
  }
  
  $query = "SELECT id, name, primaryContactId FROM cp_companies WHERE name = '$company'";
  $results = mysql_query($query,$con);
  $row_users = mysql_fetch_array($results);
  $compId = $row_users['id'];
  $primaryContact = $row_users['primaryContactId'];
  $compName = $row_users['name'];
  $companyLink = strtolower(str_replace(" ","",$compName));
  
  if(!$compId){ 	
      return_404();
  }
   
  function return_404() {
	status_header(404);
	nocache_headers();
	include( get_404_template() );
	exit;   
  }
  
  $query = "SELECT firstname, lastname FROM cp_employees WHERE id = $primaryContact";
  $results = mysql_query($query,$con);
  $row_users = mysql_fetch_array($results);
  $postAuthor = $row_users['firstname'] . "-" . $row_users['lastname'];
  
  $query = "SELECT companyLogo FROM cp_companies WHERE name = '$company'";
  $results = mysql_query($query,$con);
  $row_users = mysql_fetch_array($results);
  
  $imgsrc = "";
  $compLogo = $row_users['companyLogo'];
  if($compLogo == "."){
  $imgsrc = "images/Questionmark.jpg";
  $compLogo = "/cp-profiles/images/Questionmark.jpg";
  }
  else{
  $imgsrc = "companies/" . $compLogo;
  $compLogo = "/cp-profiles/companies/" . $compLogo;
  }
  
  $max_width = 230;
  $max_height = 230;
  

$new_height = 1;
$new_width = 1;

//getting the image dimensions
list($original_width, $original_height) = getimagesize($imgsrc);

if (($original_width > $max_width) OR ($original_height > $max_height))
{
//original width exceeds, so reduce the original width to maximum limit.
//calculate the height according to the maximum width.
    if(($original_width > $max_width) AND ($original_height <= $max_height))
    {   
        $percent = $max_width/$original_width;  
        $new_width = $max_width;
        $new_height = round ($original_height * $percent);
    }

    //image height exceeds, recudece the height to maxmimum limit.
    //calculate the width according to the maximum height limit.
    if(($original_width <= $max_width) AND ($original_height > $max_height))
    {
        $percent = $max_height/$original_height;
        $new_height = $max_height;
        $new_width = round ($original_width * $percent);
    }

    //both height and width exceeds.
    //but image can be vertical or horizontal.
    if(($original_width > $max_width) AND ($original_height > $max_height))
    {
        //if image has more width than height
        //resize width to maximum width.
        if ($original_width > $original_height)
        {
            $percent = $max_width/$original_width;
            $new_width = $max_width;
            $new_height = round ($original_height * $percent );
        }

        //image is vertical or square. More height than width.
        //resize height to maximum height.  
        else
        {
        $new_height = $max_height;
        $percent = $max_height/$original_height;
        $new_height = $max_height;
        $new_width = round ($original_width * $percent);
        }
    }
} 

?>
<?php get_header("cpTemplate"); ?>
	<div id="content" class = "cpwhat">
		<?php include("sidebar.php"); ?>
		<div class="padder left">
			<div id="information" class="left whiteShell shadowFull">				
				<div id="contentMid" class = "left">
				    <h3 class = "upSmartGradient pagetitle textCenter radius"><a href=<?PHP echo '"companyHome.php?name=' . $company .'"'; ?>><?PHP echo $company; ?></a></h3>
                                    <?php
                                    if ($compName == "Tumalow")
                                    {
                                    echo '<div id="mediaFrame" class = "radius">
					 <embed src="/cp-profiles/companies/Tumalow/Tumalowpresentation.svg" type="image/svg+xml" width="400" height="220"> </embed>
                                        </div>';
                                    } elseif ($compName == "Continuous Compost") {
                                       echo '<div id="mediaFrame" class = "radius">
                                         <embed src="/cp-profiles/companies/ContinuousCompost/ContinuousCompostpresentation.svg" type="image/svg+xml" width="400" height="220"> </embed>
                                        </div>';
                                    } else {
				    echo '<div id="mediaFrame" class = "radius">
 				               <embed width="400" height="220" src="http://www.youtube.com/watch?v=9fAZIQ-vpdw&feature=relmfu" type="application/x-shockwave-flash"> </embed>
					</div>';
                                    }
                                    ?>

					<ul>
						<li class="upSmartGradient radius left"><a href=<?PHP echo '"companyWho.php?name=' . $company .'"'; ?> > Who We Are </a></li>
						<li class="upSmartGradient radius left"><a href=<?PHP echo '"companyWhat.php?name=' . $company .'"'; ?> > What We&apos;re Doing </a></li>
					</ul>
				</div>
				<div id="socialLinks" class="left">
					<div class="fb-like slink" data-href="http://localhost" data-send="false" data-layout="button_count" data-width="450" data-show-faces="true" data-action="recommend" data-font="arial"></div>
					<div class="slink"> <a href="https://twitter.com/company" class="twitter-follow-button" data-show-count="false">Follow @company</a></div>
					<!-- Place this tag where you want the +1 button to render -->
					<div class="slink"> <g:plusone annotation="none"></g:plusone> </div>
					<div class="slink rss">
                                        <?php $companyId = get_category_id($compName);
                                        echo "<a href= \"http://www.upsmart.com/?cat=".$companyId."&feed=rss2\" title=\"Subscribe to my feed\"><img src=\"/cp-profiles/images/icon-rss.png\"/></a>";
                                        ?>
                                        </div>
				</div>	
			</div>
			<div id="blog" class="clear whiteShell shadowFull">
				<?php
				$companyId = get_category_id($compName);
				echo do_shortcode('[wp_cpl_sc cat_id=' . $companyId . ']');
				?>
			</div>	
		</div><!-- .padder -->
	</div><!-- #content -->
	<script>
	(function(d, s, id) {
	  var js, fjs = d.getElementsByTagName(s)[0];
	  if (d.getElementById(id)) return;
	  js = d.createElement(s); js.id = id;
	  js.src = "//connect.facebook.net/en_US/all.js#xfbml=1";
	  fjs.parentNode.insertBefore(js, fjs);
	}(document, 'script', 'facebook-jssdk'));
	</script>

	<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

	<!-- Place this render call where appropriate -->
	<script type="text/javascript">
	  (function() {
		var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
		po.src = 'https://apis.google.com/js/plusone.js';
		var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
	  })();
	</script>
<?php get_footer("cpTemplate"); ?>
